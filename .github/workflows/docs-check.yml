name: docs-check
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate services index
        run: node tools/docs/generate-services.mjs
      - name: Ensure SERVICES.generated.md is up to date
        run: |
          if ! git diff --quiet -- docs/SERVICES.generated.md; then
            echo "Generator output is stale. Run node tools/docs/generate-services.mjs and commit."; exit 1; fi
      - name: Validate CONTEXT references (skip staged)
        run: |
          missing=0
          for f in docs/systems/core/*.md docs/systems/supporting/*.md; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .md)
            if awk 'NR==1 && $0 ~ /^---/ {front=1; next} front && $0 ~ /^---/ {exit} front && tolower($0) ~ /staged:[[:space:]]*true/ {print "staged"; exit 0}' "$f" | grep -q staged; then
              echo "INFO: $name is staged; skipping"
              continue
            fi
            if ! grep -qi "$name" docs/CONTEXT.md; then
              echo "Missing in CONTEXT.md: $name"; missing=1
            fi
          done
          exit $missing
      - name: Ensure deployments == 3
        run: |
          n=$(ls docs/deployments/*.md 2>/dev/null | wc -l | tr -d ' ')
          test "$n" -eq 3 || (echo "Expected 3 deployments, got $n" && exit 1)
